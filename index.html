<html>

<head>
<title>ICG WebGL HW1</title>
<link rel="stylesheet" href="css/semantic.min.css">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/range.css">
<script type="text/javascript" src="js/gl-matrix-min.js"></script>
<script type="text/javascript" src="js/webgl-utils.js"></script>
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/semantic.min.js"></script>
<script type="text/javascript" src="js/jscolor.js"></script>
<script type="text/javascript" src="js/range.js"></script>
<body>
    <canvas id="canvas" style="border: none;" width="1200" height="400"></canvas>
    <div class="render block">
      <div class="panel">
        <div class="ui horizontal segments" id="noshadow">
          <div class="ui segment" id="noshadow">
            <div class="ui buttons">
              <a class="ui primary button" onclick="updateRenderer()" style="position: relative;">Re-Render</a>
              <div class="or" data-text="AS"></div>
              <div class="ui dropdown button" style="position: relative;">
                <input type="hidden" value="galvanizedTexture.jpg" id="texture">
                <i class="dropdown icon"></i>
                <div class="default text">select render texture</div>
                <div class="menu">
                  <div class="item" data-value="galvanizedTexture.jpg">galvanizedTexture</div>
                  <div class="item" data-value="moon.gif">moon</div>
                  <div class="item" data-value="red.jpg">red</div>
                  <div class="item" data-value="matcap.jpg">matte red</div>
                  <div class="item" data-value="matcap2.jpg">shinny black</div>
                  <div class="item" data-value="matcap3.jpg">skin</div>
                  <div class="item" data-value="normal.jpg">normal</div>
                  <div class="item" data-value="frontcolor">Item Front Color</div>
                </div>
              </div>
            </div>
            <br>
            <br>
            <div class="ui mini basic blue button" onclick="resizeToSame()">Compare Mode</div>
            <div class="ui mini basic positive button" onclick="initSetting()">resume</div>
            <div class="ui checkbox re-render-setting">
              <input type="checkbox" id="1">
              <label>remain setting?</label>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui checkbox object">
              <input type="checkbox" checked id="1">
              <label>Object #1: </label>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="Mig27" id="object1">
              <i class="dropdown icon"></i>
              <div class="default text">select #1 object</div>
              <div class="menu">
                <div class="item" data-value="csie.tri">csie</div>
                <div class="item" data-value="Mig27">Mig27</div>
                <div class="item" data-value="Teapot">Teapot</div>
                <div class="item" data-value="tomcat.tri">Tomcat</div>
                <div class="item" data-value="kangaroo.tri">Kangaroo</div>
                <div class="item" data-value="easter.tri">Easter</div>
                <div class="item" data-value="pot.tri">teapot (with color)</div>
              </div>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="flat-" id="shading1">
              <i class="dropdown icon"></i>
              <div class="default text">select #1 shading</div>
              <div class="menu">
                <div class="item" data-value="flat-">flat</div>
                <div class="item" data-value="gouraud-">gouraud</div>
                <div class="item" data-value="phong-">phong</div>
                <div class="item" data-value="sem-vertex-">spherical enviorment per vertex</div>
                <div class="item" data-value="sem-fragment-">spherical enviorment per fragment</div>
                <div class="item" data-value="cel-">cel (toon)</div>
                <div class="item" data-value="blinn-phong-">blinn phong</div>
              </div>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui checkbox object">
              <input type="checkbox" checked id="2">
              <label>Object #2: </label>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="Teapot" id="object2">
              <i class="dropdown icon"></i>
              <div class="default text">select #2 object</div>
              <div class="menu">
                <div class="item" data-value="csie.tri">csie</div>
                <div class="item" data-value="Mig27">Mig27</div>
                <div class="item" data-value="Teapot">Teapot</div>
                <div class="item" data-value="tomcat.tri">Tomcat</div>
                <div class="item" data-value="kangaroo.tri">Kangaroo</div>
                <div class="item" data-value="easter.tri">Easter</div>
                <div class="item" data-value="pot.tri">teapot (with color)</div>
              </div>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="gouraud-" id="shading2">
              <i class="dropdown icon"></i>
              <div class="default text">select #2 shading</div>
              <div class="menu">
                <div class="item" data-value="flat-">flat</div>
                <div class="item" data-value="gouraud-">gouraud</div>
                <div class="item" data-value="phong-">phong</div>
                <div class="item" data-value="sem-vertex-">spherical enviorment per vertex</div>
                <div class="item" data-value="sem-fragment-">spherical enviorment per fragment</div>
                <div class="item" data-value="cel-">cel (toon)</div>
                <div class="item" data-value="blinn-phong-">blinn phong</div>
              </div>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui checkbox object">
              <input type="checkbox" checked id="3">
              <label>Object #3: </label>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="easter.tri" id="object3">
              <i class="dropdown icon"></i>
              <div class="default text">select #3 object</div>
              <div class="menu">
                <div class="item" data-value="csie.tri">csie</div>
                <div class="item" data-value="Mig27">Mig27</div>
                <div class="item" data-value="Teapot">Teapot</div>
                <div class="item" data-value="tomcat.tri">Tomcat</div>
                <div class="item" data-value="kangaroo.tri">Kangaroo</div>
                <div class="item" data-value="easter.tri">Easter</div>
                <div class="item" data-value="pot.tri">teapot (with color)</div>
              </div>
            </div>
            <div class="ui dropdown button" style="position: relative;">
              <input type="hidden" value="phong-" id="shading3">
              <i class="dropdown icon"></i>
              <div class="default text">select #3 shading</div>
              <div class="menu">
                <div class="item" data-value="flat-">flat</div>
                <div class="item" data-value="gouraud-">gouraud</div>
                <div class="item" data-value="phong-">phong</div>
                <div class="item" data-value="sem-vertex-">spherical enviorment per vertex</div>
                <div class="item" data-value="sem-fragment-">spherical enviorment per fragment</div>
                <div class="item" data-value="cel-">cel (toon)</div>
                <div class="item" data-value="blinn-phong-">blinn phong</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="ui divider"></div>
    <div class="lightColor block">
      <div class="panel lightColorAmbient">
        <button class="ui button" id="lightColorAmbient-button">abmient light color</button>
        <table>
          <tr><th>RGB</th><td><input id="lightColorAmbient-rgb" onchange="setString('lightColorAmbient', this.value)" /></td></tr>
          <tr><th>HEX</th><td><input id="lightColorAmbient-hex" onchange="setString('lightColorAmbient', this.value)" /></td></tr>
          <tr class="red"><th>R</th><td><input id="lightColorAmbient-red" class="short" onchange="setRGB('lightColorAmbient', this.value, null, null)" /></td></tr>
          <tr class="grn"><th>G</th><td><input id="lightColorAmbient-grn" class="short" onchange="setRGB('lightColorAmbient', null, this.value, null)" /></td></tr>
          <tr class="blu"><th>B</th><td><input id="lightColorAmbient-blu" class="short" onchange="setRGB('lightColorAmbient', null, null, this.value)" /></td></tr>
        </table>
      </div>
      <div class="panel lightColorDiffuse">
        <button class="ui button" id="lightColorDiffuse-button">diffse light color</button>
        <table>
          <tr><th>RGB</th><td><input id="lightColorDiffuse-rgb" onchange="setString('lightColorDiffuse', this.value)" /></td></tr>
          <tr><th>HEX</th><td><input id="lightColorDiffuse-hex" onchange="setString('lightColorDiffuse', this.value)" /></td></tr>
          <tr class="red"><th>R</th><td><input id="lightColorDiffuse-red" class="short" onchange="setRGB('lightColorDiffuse', this.value, null, null)" /></td></tr>
          <tr class="grn"><th>G</th><td><input id="lightColorDiffuse-grn" class="short" onchange="setRGB('lightColorDiffuse', null, this.value, null)" /></td></tr>
          <tr class="blu"><th>B</th><td><input id="lightColorDiffuse-blu" class="short" onchange="setRGB('lightColorDiffuse', null, null, this.value)" /></td></tr>
        </table>
      </div>
      <div class="panel lightColorSpecular">
        <button class="ui button" id="lightColorSpecular-button">Specular light color</button>
        <table>
          <tr><th>RGB</th><td><input id="lightColorSpecular-rgb" onchange="setString('lightColorSpecular', this.value)" /></td></tr>
          <tr><th>HEX</th><td><input id="lightColorSpecular-hex" onchange="setString('lightColorSpecular', this.value)" /></td></tr>
          <tr class="red"><th>R</th><td><input id="lightColorSpecular-red" class="short" onchange="setRGB('lightColorSpecular', this.value, null, null)" /></td></tr>
          <tr class="grn"><th>G</th><td><input id="lightColorSpecular-grn" class="short" onchange="setRGB('lightColorSpecular', null, this.value, null)" /></td></tr>
          <tr class="blu"><th>B</th><td><input id="lightColorSpecular-blu" class="short" onchange="setRGB('lightColorSpecular', null, null, this.value)" /></td></tr>
        </table>
      </div>
      <div class="ui center aligned segments panel">
        <div class="ui horizontal segments">
          <div class="ui segment">
            <div class="ui checkbox light" id="lightpenel">
              <input type="checkbox" checked id="1">
              <label>Main Light</label>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui mini input">
              X:
              <input type="text" value="-10" placeholder="-10" id="light1x">
            </div>
            <div class="ui mini input">
              Y:
              <input type="text" value="4" placeholder="4" id="light1y">
            </div>
            <div class="ui mini input">
              Z:
              <input type="text" value="-20" placeholder="-20" id="light1z">
            </div>
          </div>
        </div>
        <div class="ui horizontal segments">
          <div class="ui segment">
            <div class="ui checkbox light" id="lightpenel">
              <input type="checkbox" checked id="2">
              <label>Fill Light    </label>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui mini input">
              X:
              <input type="text" value="90" placeholder="90" id="light2x">
            </div>
            <div class="ui mini input">
              Y:
              <input type="text" value="-80" placeholder="80" id="light2y">
            </div>
            <div class="ui mini input">
              Z:
              <input type="text" value="-60" placeholder="-60" id="light2z">
            </div>
          </div>
        </div>
        <div class="ui horizontal segments">
          <div class="ui segment">
            <div class="ui checkbox light" id="lightpenel">
              <input type="checkbox" checked id="3">
              <label>Back Light</label>
            </div>
          </div>
          <div class="ui segment">
            <div class="ui mini input">
              X:
              <input type="text"  value="100" placeholder="100" id="light3x">
            </div>
            <div class="ui mini input">
              Y:
              <input type="text" value="40" placeholder="40" id="light3y">
            </div>
            <div class="ui mini input">
              Z:
              <input type="text" value="-200" placeholder="-200" id="light3z">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="ui divider"></div>
    <div class="ui materialColor block horizontal segments">
      <div class="ui segment" style="width: 250px;">
        <div class="panel materialAmbient">
          <button class="ui button" id="materialAmbient-button">abmient material color</button>
          <table>
            <tr><th>RGB</th><td><input id="materialAmbient-rgb" onchange="setString('materialAmbient', this.value)" /></td></tr>
            <tr><th>HEX</th><td><input id="materialAmbient-hex" onchange="setString('materialAmbient', this.value)" /></td></tr>
            <tr class="red"><th>R</th><td><input id="materialAmbient-red" class="short" onchange="setRGB('materialAmbient', this.value, null, null)" /></td></tr>
            <tr class="grn"><th>G</th><td><input id="materialAmbient-grn" class="short" onchange="setRGB('materialAmbient', null, this.value, null)" /></td></tr>
            <tr class="blu"><th>B</th><td><input id="materialAmbient-blu" class="short" onchange="setRGB('materialAmbient', null, null, this.value)" /></td></tr>
          </table>
        </div>
        <div class="panel materialDiffuse">
          <button class="ui button" id="materialDiffuse-button">diffuse material color</button>
          <table>
            <tr><th>RGB</th><td><input id="materialDiffuse-rgb" onchange="setString('materialDiffuse', this.value)" /></td></tr>
            <tr><th>HEX</th><td><input id="materialDiffuse-hex" onchange="setString('materialDiffuse', this.value)" /></td></tr>
            <tr class="red"><th>R</th><td><input id="materialDiffuse-red" class="short" onchange="setRGB('materialDiffuse', this.value, null, null)" /></td></tr>
            <tr class="grn"><th>G</th><td><input id="materialDiffuse-grn" class="short" onchange="setRGB('materialDiffuse', null, this.value, null)" /></td></tr>
            <tr class="blu"><th>B</th><td><input id="materialDiffuse-blu" class="short" onchange="setRGB('materialDiffuse', null, null, this.value)" /></td></tr>
          </table>
        </div>
        <div class="panel materialSpecular">
          <button class="ui button" id="materialSpecular-button">specular material color</button>
          <table>
            <tr><th>RGB</th><td><input id="materialSpecular-rgb" onchange="setString('materialSpecular', this.value)" /></td></tr>
            <tr><th>HEX</th><td><input id="materialSpecular-hex" onchange="setString('materialSpecular', this.value)" /></td></tr>
            <tr class="red"><th>R</th><td><input id="materialSpecular-red" class="short" onchange="setRGB('materialSpecular', this.value, null, null)" /></td></tr>
            <tr class="grn"><th>G</th><td><input id="materialSpecular-grn" class="short" onchange="setRGB('materialSpecular', null, this.value, null)" /></td></tr>
            <tr class="blu"><th>B</th><td><input id="materialSpecular-blu" class="short" onchange="setRGB('materialSpecular', null, null, this.value)" /></td></tr>
          </table>
        </div>
      </div>
      <div class="ui segment">
        <b>shininess</b>
        <p id="shininess-value">32</p>
        <div class="ui range" id="shininess-range"></div>
      </div>
    </div>


</body>
<script id="blinn-phong-fragmentShader" type="x-shader/x-fragment">
  precision highp float;
  uniform mat3 uNMatrix;
  uniform vec3 uMaterialAmbient;
  uniform vec3 uMaterialDiffuse;
  uniform vec3 uMaterialSpecular;
  uniform vec3 uAmbient;
  uniform vec3 uDiffuse;
  uniform vec3 uSpecular;
  uniform float uShininess;
  uniform vec4 lightPositions[3];
  uniform mat4 uMVMatrix;
  uniform sampler2D uSampler;
  uniform bool uIsLightShow[3];
  uniform bool uIfUseTexture;

  varying vec3 vVertexPosition;
  varying vec2 vTextureCoord;
  varying vec3 vVertexNormal;
  varying vec3 vVertexFrontColor;


  void main(void) {
      vec3 eyeDirection = normalize(-vVertexPosition);
      vec3 pos = (uMVMatrix * vec4(vVertexPosition, 1.0)).xyz;

      //單位法向量
      vec3 normal = normalize(uNMatrix * vVertexNormal);
      vec3 lightWeighting = vec3(0.0,0.0,0.0);
      for(int i = 0; i<3; i++) {
        if (uIsLightShow[i]) {
          //光的方向
          vec3 L = normalize(lightPositions[i].xyz - vVertexPosition);
          //半角公式
          vec3 H = normalize(L + eyeDirection);

          //specular weight
          vec3 reflectionDirection = reflect(-L, normal);
          float specularWeight = pow(max(dot(H, normal),0.0),uShininess);
          vec3 specular = specularWeight * (uSpecular*uMaterialSpecular);

          //diffuse weight
          float diffuseWeight = max(dot(normal, L), 0.0);
          vec3 diffuse = diffuseWeight * (uDiffuse*uMaterialDiffuse);
          lightWeighting += uAmbient*uMaterialAmbient + specular + diffuse;
        }
      }
      vec4 fragcolor;
      if (uIfUseTexture) {
        fragcolor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
      }
      else {
        fragcolor = vec4(vVertexFrontColor, 1.0);
      }
      gl_FragColor = vec4(fragcolor.rgb * lightWeighting, fragcolor.a);
  }
</script>

<script id="blinn-phong-vertexShader" type="x-shader/x-vertex">
    precision highp float;

    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexFrontColor;

    uniform vec4 lightPositions[3];
    uniform mat3 uNMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec3 vVertexPosition;
    varying vec2 vTextureCoord;
    varying vec3 vVertexNormal;
    varying vec3 vVertexFrontColor;

    void main(void) {
        vVertexNormal = aVertexNormal;
        vTextureCoord = aTextureCoord;
        //vVertexPosition = aVertexPosition;
        vVertexPosition = (uMVMatrix * vec4(aVertexPosition, 1.0)).xyz;

        vVertexFrontColor = aVertexFrontColor;
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }
</script>
<script id="cel-fragmentShader" type="x-shader/x-fragment">
  precision highp float;
  uniform mat3 uNMatrix;
  uniform vec3 uMaterialAmbient;
  uniform vec3 uMaterialDiffuse;
  uniform vec3 uMaterialSpecular;
  uniform vec3 uAmbient;
  uniform vec3 uDiffuse;
  uniform vec3 uSpecular;
  uniform float uShininess;
  uniform vec4 lightPositions[3];
  uniform mat4 uMVMatrix;
  uniform sampler2D uSampler;
  uniform bool uIsLightShow[3];
  uniform bool uIfUseTexture;

  varying vec3 vVertexPosition;
  varying vec2 vTextureCoord;
  varying vec3 vVertexNormal;
  varying vec3 vVertexFrontColor;


  void main(void) {
      float levels = 5.0;
      float scaleFactor = 1.0 / levels;
      vec3 eyeDirection = normalize(-vVertexPosition);
      vec3 pos = (uMVMatrix * vec4(vVertexPosition, 1.0)).xyz;


      //單位法向量
      vec3 normal = normalize(uNMatrix * vVertexNormal);
      vec3 lightWeighting = vec3(0.0,0.0,0.0);
      for(int i = 0; i<3; i++) {
        if (uIsLightShow[i]) {
          //光的方向
          vec3 L = normalize(lightPositions[i].xyz - vVertexPosition);

          //specular weight
          vec3 reflectionDirection = reflect(-L, normal);
          float specularWeight = pow(max(dot(reflectionDirection, eyeDirection),0.0),uShininess);
          vec3 specular = vec3(0.0,0.0,0.0);
          if (specularWeight > 0.4) {
            specular = specularWeight * (uSpecular*uMaterialSpecular);
          }

          float edgeDetection = dot(normal, L);

          //diffuse weight
          float diffuseWeight = max(dot(normal, L), 0.0);
          vec3 diffuse = floor(diffuseWeight*levels) * scaleFactor * (uDiffuse*uMaterialDiffuse);
          if (edgeDetection > 0.2) {
            lightWeighting += (uAmbient*uMaterialAmbient + specular + diffuse);
          }
        }
      }
      vec4 fragcolor;
      if (uIfUseTexture) {
        fragcolor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
      }
      else {
        fragcolor = vec4(vVertexFrontColor, 1.0);
      }
      gl_FragColor = vec4(fragcolor.rgb * lightWeighting, fragcolor.a);
  }
</script>

<script id="cel-vertexShader" type="x-shader/x-vertex">
    precision highp float;

    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexFrontColor;

    uniform vec4 lightPositions[3];
    uniform mat3 uNMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec3 vVertexPosition;
    varying vec2 vTextureCoord;
    varying vec3 vVertexNormal;
    varying vec3 vVertexFrontColor;

    void main(void) {
        vVertexNormal = aVertexNormal;
        vTextureCoord = aTextureCoord;
        //vVertexPosition = aVertexPosition;
        vVertexPosition = (uMVMatrix * vec4(aVertexPosition, 1.0)).xyz;

        vVertexFrontColor = aVertexFrontColor;
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }
</script>


<script id="sem-fragment-fragmentShader" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSampler;
  varying vec3 e;
  varying vec3 n;

  void main(void) {
		vec3 r = reflect( e, n );
		float m = 2.0 * sqrt( pow( r.x, 2.0 ) + pow( r.y, 2.0 ) + pow( r.z + 1.0, 2.0 ) );
		vec2 vN = r.xy / m + 0.5;
    vec3 base = texture2D( uSampler, vN ).rgb;
    gl_FragColor = vec4( base, 1. );
  }
</script>
<script id="sem-fragment-vertexShader" type="x-shader/x-vertex">
  precision mediump float;

  attribute vec3 aVertexPosition;
  attribute vec3 aVertexNormal;
  attribute vec2 aTextureCoord;
  attribute vec3 aVertexFrontColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform mat3 uNMatrix;

  varying vec3 e;
  varying vec3 n;

	void main(void) {

    vec4 pos = vec4(aVertexPosition, 1.0);
    e = normalize(vec3(uMVMatrix * vec4(aVertexPosition, 1.0)));
		n = normalize( uNMatrix * aVertexNormal );
		gl_Position = uPMatrix * uMVMatrix * pos;
	}
</script>
<script id="sem-vertex-fragmentShader" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSampler;

	varying vec2 vN;

  void main(void) {

    vec3 base = texture2D( uSampler, vN ).rgb;
    gl_FragColor = vec4( base, 1. );
  }
</script>
<script id="sem-vertex-vertexShader" type="x-shader/x-vertex">
  precision mediump float;

  attribute vec3 aVertexPosition;
  attribute vec3 aVertexNormal;
  attribute vec2 aTextureCoord;
  attribute vec3 aVertexFrontColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform mat3 uNMatrix;

	varying vec2 vN;
	void main(void) {
    vec4 pos = vec4(aVertexPosition, 1.0);
    vec3 e = normalize(vec3(uMVMatrix * vec4(aVertexPosition, 1.0)));
		vec3 n = normalize( uNMatrix * aVertexNormal );
		vec3 r = reflect( e, n );
		float m = 2.0 * sqrt( pow( r.x, 2.0 ) + pow( r.y, 2.0 ) + pow( r.z + 1.0, 2.0 ) );
		vN = r.xy / m + 0.5;
		gl_Position = uPMatrix * uMVMatrix * pos;
	}
</script>

<script id="gouraud-fragmentShader" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSampler;
  uniform bool uIfUseTexture;
  varying vec3 vVertexFrontColor;
  varying vec2 vTextureCoord;
  varying vec3 vlightWeighting;

  void main(void) {
      vec4 vFragcolor;
      if (uIfUseTexture) {
        vFragcolor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
      }
      else {
        vFragcolor = vec4(vVertexFrontColor, 1.0);
      }
      gl_FragColor = vec4(vFragcolor.rgb * vlightWeighting, vFragcolor.a);
  }
</script>
<script id="gouraud-vertexShader" type="x-shader/x-vertex">
  precision mediump float;

  attribute vec3 aVertexPosition;
  attribute vec3 aVertexNormal;
  attribute vec2 aTextureCoord;
  attribute vec3 aVertexFrontColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform mat3 uNMatrix;
  uniform vec4 lightPositions[3];
  uniform vec3 uMaterialAmbient;
  uniform vec3 uMaterialDiffuse;
  uniform vec3 uMaterialSpecular;
  uniform vec3 uAmbient;
  uniform vec3 uDiffuse;
  uniform vec3 uSpecular;
  uniform float uShininess;
  uniform bool uIsLightShow[3];

  varying vec2 vTextureCoord;
  varying vec3 vlightWeighting;
  varying vec3 vVertexFrontColor;

  void main(void) {
    vec3 pos = (uMVMatrix * vec4(aVertexPosition, 1.0)).xyz;
    //單位法向量
    vec3 normal = normalize(uNMatrix * aVertexNormal);

    vec3 eyeDirection = normalize(-pos);

    vlightWeighting = vec3(0.0,0.0,0.0);
    for(int i = 0; i<3; i++) {
      if (uIsLightShow[i]) {
        //光的方向
        vec3 L = normalize(lightPositions[i].xyz - pos);
        //specular weight
        vec3 reflectionDirection = reflect(-L, normal);
        float specularWeight = pow(max(dot(reflectionDirection, eyeDirection),0.0),uShininess);
        vec3 specular = specularWeight * (uSpecular*uMaterialSpecular);

        //diffuse weight
        float diffuseWeight = max(dot(normal, L), 0.0);
        vec3 diffuse = diffuseWeight * (uDiffuse*uMaterialDiffuse);
        vlightWeighting += uAmbient*uMaterialAmbient + specular + diffuse;
      }
    }
    vTextureCoord = aTextureCoord;
    vVertexFrontColor = aVertexFrontColor;
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
  }
</script>

<script id="phong-fragmentShader" type="x-shader/x-fragment">
  precision highp float;
  uniform mat3 uNMatrix;
  uniform vec3 uMaterialAmbient;
  uniform vec3 uMaterialDiffuse;
  uniform vec3 uMaterialSpecular;
  uniform vec3 uAmbient;
  uniform vec3 uDiffuse;
  uniform vec3 uSpecular;
  uniform float uShininess;
  uniform vec4 lightPositions[3];
  uniform mat4 uMVMatrix;
  uniform sampler2D uSampler;
  uniform bool uIsLightShow[3];
  uniform bool uIfUseTexture;

  varying vec3 vVertexPosition;
  varying vec2 vTextureCoord;
  varying vec3 vVertexNormal;
  varying vec3 vVertexFrontColor;


  void main(void) {
      vec3 eyeDirection = normalize(-vVertexPosition);
      vec3 pos = (uMVMatrix * vec4(vVertexPosition, 1.0)).xyz;


      //單位法向量
      vec3 normal = normalize(uNMatrix * vVertexNormal);
      vec3 lightWeighting = vec3(0.0,0.0,0.0);
      for(int i = 0; i<3; i++) {
        if (uIsLightShow[i]) {
          //光的方向
          vec3 L = normalize(lightPositions[i].xyz - vVertexPosition);

          //specular weight
          vec3 reflectionDirection = reflect(-L, normal);
          float specularWeight = pow(max(dot(reflectionDirection, eyeDirection),0.0),uShininess);
          vec3 specular = specularWeight * (uSpecular*uMaterialSpecular);

          //diffuse weight
          float diffuseWeight = max(dot(normal, L), 0.0);
          vec3 diffuse = diffuseWeight * (uDiffuse*uMaterialDiffuse);
          lightWeighting += uAmbient*uMaterialAmbient + specular + diffuse;
        }
      }
      vec4 fragcolor;
      if (uIfUseTexture) {
        fragcolor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
      }
      else {
        fragcolor = vec4(vVertexFrontColor, 1.0);
      }
      gl_FragColor = vec4(fragcolor.rgb * lightWeighting, fragcolor.a);
  }
</script>

<script id="phong-vertexShader" type="x-shader/x-vertex">
    precision highp float;

    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexFrontColor;

    uniform vec4 lightPositions[3];
    uniform mat3 uNMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec3 vVertexPosition;
    varying vec2 vTextureCoord;
    varying vec3 vVertexNormal;
    varying vec3 vVertexFrontColor;

    void main(void) {
        vVertexNormal = aVertexNormal;
        vTextureCoord = aTextureCoord;
        //vVertexPosition = aVertexPosition;
        vVertexPosition = (uMVMatrix * vec4(aVertexPosition, 1.0)).xyz;

        vVertexFrontColor = aVertexFrontColor;
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }
</script>

<script id="flat-fragmentShader" type="x-shader/x-fragment">
    #extension GL_OES_standard_derivatives : enable

    precision mediump float;

    varying vec4 vFragcolor;
    varying vec3 vVertexPosition;
    varying vec3 L[3];

    uniform vec3 uMaterialAmbient;
    uniform vec3 uMaterialDiffuse;
    uniform vec3 uMaterialSpecular;
    uniform vec3 uAmbient;
    uniform vec3 uDiffuse;
    uniform vec3 uSpecular;
    uniform float uShininess;
    uniform bool uIsLightShow[3];
    uniform vec4 lightPositions[3];


    void main(void) {
      vec3 eyeDirection = normalize(-vVertexPosition);
      vec3 dx = dFdx(vVertexPosition);
      vec3 dy = dFdy(vVertexPosition);
      vec3 normal = normalize(cross(dx, dy));

      vec3 lightWeighting = vec3(0.0,0.0,0.0);
      for(int i = 0; i<3; i++) {
        if(uIsLightShow[i]) {
          //specular weight
          vec3 reflectionDirection = reflect(-L[i], normal);
          float specularWeight = pow(max(dot(reflectionDirection, eyeDirection),0.0),uShininess);
          vec3 specular = specularWeight * (uSpecular*uMaterialSpecular);
          //diffuse weight
          float diffuseWeight = max(dot(normal, L[i]), 0.0);
          vec3 diffuse = diffuseWeight * (uDiffuse*uMaterialDiffuse);
          lightWeighting += uAmbient*uMaterialAmbient + specular + diffuse;
        }
      }

      gl_FragColor = vec4(vFragcolor.rgb * lightWeighting, vFragcolor.a);
    }

</script>
<script id="flat-vertexShader" type="x-shader/x-vertex">
    precision mediump float;

    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexFrontColor;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat3 uNMatrix;

    varying vec4 vFragcolor;
    varying vec3 vVertexPosition;
    varying vec3 L[3];

    uniform vec4 lightPositions[3];
    uniform sampler2D uSampler;
    uniform bool uIfUseTexture;

    void main(void) {
        vec3 pos = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;
        vVertexPosition = (uMVMatrix * vec4(aVertexPosition, 1.0)).xyz;
        for(int i = 0; i<3; i++) {
          //光的方向
          L[i] = normalize(lightPositions[i].xyz - pos);
        }
        if (uIfUseTexture) {
          vFragcolor = texture2D(uSampler, vec2(aTextureCoord.s, aTextureCoord.t));
        }
        else {
          vFragcolor = vec4(aVertexFrontColor, 1.0);
        }
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }

</script>
<script type="text/javascript" src="js/main.js"></script>
</head>

</html>
